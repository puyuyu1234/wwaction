/**
 * ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * stages/*.json ã‚’èª­ã¿è¾¼ã¿ã€ãƒ†ãƒ¼ãƒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é©ç”¨ã—ã¦ src/generated/stages.ts ã‚’ç”Ÿæˆ
 */

import { readdirSync, readFileSync, writeFileSync } from 'fs'
import { join } from 'path'

// ãƒ†ãƒ¼ãƒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆthemeDefaults.tsã¨åŒã˜å€¤ã‚’å®šç¾©ï¼‰
const THEME_DEFAULTS: Record<string, { bg: string[]; fg: string[] }> = {
  plain: {
    bg: [' ', ' ', ' ', ' ', 'H', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y'],
    fg: [''],
  },
  forest: {
    bg: [''],
    fg: [''],
  },
}

interface StageInput {
  name?: string
  engName?: string
  bgm?: string
  theme: string
  bg?: string[]
  fg?: string[]
  layers: string[][]
}

interface StageOutput {
  name?: string
  engName?: string
  bgm?: string
  theme: string
  bg: string[]
  fg: string[]
  stages: string[][]
}

const stagesDir = join(process.cwd(), 'stages')
const outputFile = join(process.cwd(), 'src/generated/stages.ts')

console.log('ğŸ”„ Generating stages.ts from JSON files...')

// stages/*.json ã‚’èª­ã¿è¾¼ã¿
const files = readdirSync(stagesDir)
  .filter((f: string) => f.match(/^stage-\d{2}\.json$/))
  .sort()

if (files.length === 0) {
  console.error('âŒ No stage-XX.json files found in stages/ directory')
  process.exit(1)
}

// å„ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
const stageData: StageOutput[] = files.map((file: string) => {
  const filePath = join(stagesDir, file)
  const content = readFileSync(filePath, 'utf-8')
  const input = JSON.parse(content) as StageInput

  const theme = input.theme || 'plain'
  const defaults = THEME_DEFAULTS[theme] || THEME_DEFAULTS.plain

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
  const output: StageOutput = {
    theme,
    bg: input.bg ?? defaults.bg,
    fg: input.fg ?? defaults.fg,
    stages: input.layers,
  }

  // ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
  if (input.name) output.name = input.name
  if (input.engName) output.engName = input.engName
  if (input.bgm) output.bgm = input.bgm

  return output
})

// TypeScriptã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å‡ºåŠ›
const stageDataJSON = JSON.stringify(stageData, null, 2)

const output = `/**
 * ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
 * DO NOT EDIT MANUALLY - Generated by scripts/generate-stages.ts
 */

import type { StageData } from '@game/types'

export const STAGEDATA: StageData[] = ${stageDataJSON}
`

// ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
writeFileSync(outputFile, output, 'utf-8')

console.log(`âœ… Generated ${files.length} stages -> ${outputFile}`)
