/**
 * ãƒ†ãƒ¼ãƒã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * themes/*.json ã‚’èª­ã¿è¾¼ã¿ src/generated/themes.ts ã‚’ç”Ÿæˆ
 */

import { readdirSync, readFileSync, writeFileSync } from 'fs'
import { join } from 'path'

interface ThemeData {
  blocks: Record<string, { frame: number[]; type: string; param?: Record<string, unknown> }>
  entities: Record<string, { entityClass: string }>
}

const themesDir = join(process.cwd(), 'themes')
const outputFile = join(process.cwd(), 'src/generated/themes.ts')

console.log('ğŸ”„ Generating themes.ts from JSON files...')

// themes/*.json ã‚’èª­ã¿è¾¼ã¿
const files = readdirSync(themesDir)
  .filter((f: string) => f.endsWith('.json'))
  .sort()

if (files.length === 0) {
  console.error('âŒ No theme JSON files found in themes/ directory')
  process.exit(1)
}

// å„ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿
const blockOverrides: Record<string, Record<string, unknown>> = {}
const entityOverrides: Record<string, Record<string, unknown>> = {}

files.forEach((file: string) => {
  const themeName = file.replace('.json', '')
  const filePath = join(themesDir, file)
  const content = readFileSync(filePath, 'utf-8')
  const data = JSON.parse(content) as ThemeData

  // ç©ºã§ãªã„ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã®ã¿è¿½åŠ 
  if (Object.keys(data.blocks).length > 0) {
    blockOverrides[themeName] = data.blocks
  }
  if (Object.keys(data.entities).length > 0) {
    entityOverrides[themeName] = data.entities
  }

  console.log(`  âœ… ${file} (blocks: ${Object.keys(data.blocks).length}, entities: ${Object.keys(data.entities).length})`)
})

// ãƒ–ãƒ­ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãŒã‚ã‚‹å ´åˆã®ã¿CollisionTypeã‚’import
const hasBlockOverrides = Object.keys(blockOverrides).length > 0
const collisionTypeImport = hasBlockOverrides ? "import { CollisionType } from '@game/types'\n" : ''

// TypeScriptã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å‡ºåŠ›
const output = `/**
 * ãƒ†ãƒ¼ãƒã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
 * DO NOT EDIT MANUALLY - Generated by scripts/generate-themes.ts
 */

${collisionTypeImport}import type { BlockDataMap, EntityDataMap } from '@game/types'

/**
 * ãƒ†ãƒ¼ãƒåˆ¥ãƒ–ãƒ­ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
 */
export const THEME_BLOCK_OVERRIDE: Record<string, BlockDataMap> = ${JSON.stringify(blockOverrides, null, 2).replace(/"type":\s*"(\w+)"/g, 'type: CollisionType.$1')}

/**
 * ãƒ†ãƒ¼ãƒåˆ¥ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
 */
export const THEME_ENTITY_OVERRIDE: Record<string, EntityDataMap> = ${JSON.stringify(entityOverrides, null, 2)}
`

// ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
writeFileSync(outputFile, output, 'utf-8')

console.log(`\nâœ… Generated themes -> ${outputFile}`)
